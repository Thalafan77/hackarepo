<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Care Dashboard</title>
  <style>
    :root { color-scheme: light; }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: navy;
      color: black;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: gold;
      color: navy;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      letter-spacing: 1px;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 18px gray;
      max-width: 560px;
      width: 100%;
      text-align: center;
      border: 3px solid gold;
    }
    .card h2 { color: navy; margin-bottom: 1rem; }
    .status {
      font-size: 1.3rem;
      margin: 1rem 0;
      padding: 0.9rem;
      border-radius: 0.6rem;
      font-weight: bold;
      border: 2px solid gold;
      background: white;
    }
    .status.wet { color: darkgreen; }
    .status.dry { color: darkred; }
    .badge {
      display: inline-block;
      margin-left: 0.5rem;
      padding: 0.2rem 0.6rem;
      border-radius: 0.5rem;
      background: gold;
      color: navy;
      font-size: 0.85rem;
      font-weight: bold;
    }
    button {
      background: navy;
      color: white;
      border: 2px solid gold;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      border-radius: 0.6rem;
      cursor: pointer;
      transition: all 0.25s ease;
      margin-top: 0.5rem;
      font-weight: bold;
    }
    button:hover { background: gold; color: navy; }
    footer {
      background: gold;
      text-align: center;
      padding: 0.7rem;
      font-size: 0.95rem;
      color: navy;
      font-weight: bold;
    }
    .row { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; }
    .pill {
      padding: 0.4rem 0.8rem;
      border: 1px solid gold;
      border-radius: 999px;
      background: white;
      color: navy;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .muted { color: dimgray; font-size: 0.95rem; }
  </style>
</head>
<body>
  <header>ðŸŒ± Plant Care Dashboard</header>
  <main>
    <div class="card">
      <h2>Soil Condition</h2>
      <div id="status" class="status">Waiting for dataâ€¦ <span class="badge">Gold Highlight</span></div>

      <div class="row">
        <button id="connect">Connect to Arduino</button>
        <button id="toggle-audio">Resume Audio</button>
      </div>

      <div style="margin-top: 1.5rem;">
        <p><strong>Now Playing:</strong> <span id="track">None</span></p>
        <div class="row">
          <span class="pill">Theme: navy â€¢ white â€¢ gold</span>
          <span class="pill" id="serial-pill">Serial: disconnected</span>
        </div>
      </div>

      <p class="muted" style="margin-top:1rem;">Tip: Audio might need one click to start (autoplay rules).</p>
    </div>
  </main>
  <footer>Made with ðŸ’› for your plants â€¢ classic look, modern brains</footer>

  <script>
    // ========= Audio Engine (no files needed) =========
    let audioCtx;
    let masterGain;
    let activeNodes = [];

    async function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.3;
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
    }

    function stopAll() {
      activeNodes.forEach(n => { try { n.stop ? n.stop() : n.disconnect(); } catch(e) {} });
      activeNodes = [];
    }

    // 432 Hz calming tone (smooth on/off, no clicks)
    async function play432() {
      await ensureAudio();
      stopAll();
      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.setValueAtTime(432, audioCtx.currentTime);
      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(1.0, audioCtx.currentTime + 0.5);
      osc.connect(gain).connect(masterGain);
      osc.start();
      activeNodes.push(osc);
    }

    // Simple "sad" loop: slow minor arpeggio (A minor vibes)
    async function playSad() {
      await ensureAudio();
      stopAll();

      const tempo = 60; // bpm
      const beat = 60 / tempo;
      const notes = [
        220.00, // A3
        261.63, // C4
        329.63, // E4
        261.63, // C4
        207.65, // G#3 (spice)
        261.63, // C4
      ];

      // schedule loop using a single oscillator per note (lightweight)
      let time = audioCtx.currentTime + 0.05;
      function scheduleOnce() {
        notes.forEach((f, i) => {
          const start = time + i * beat;
          const dur = beat * 0.9;
          const osc = audioCtx.createOscillator();
          osc.type = "sine";
          osc.frequency.setValueAtTime(f, start);

          const g = audioCtx.createGain();
          g.gain.setValueAtTime(0.0001, start);
          g.gain.exponentialRampToValueAtTime(0.6, start + 0.1);
          g.gain.exponentialRampToValueAtTime(0.0001, start + dur);

          osc.connect(g).connect(masterGain);
          osc.start(start);
          osc.stop(start + dur + 0.05);
          activeNodes.push(osc);
        });
        time += notes.length * beat;
      }

      // loop by re-scheduling every bar
      const loop = setInterval(scheduleOnce, notes.length * beat * 1000);
      scheduleOnce();

      // push a stopper
      activeNodes.push({ stop: () => clearInterval(loop) });
    }

    // ========= UI helpers =========
    const statusDiv = document.getElementById("status");
    const track = document.getElementById("track");
    const serialPill = document.getElementById("serial-pill");
    const toggleBtn = document.getElementById("toggle-audio");

    toggleBtn.addEventListener("click", async () => {
      await ensureAudio();
    });

    function setWet() {
      statusDiv.textContent = "Plant is Happy (Wet)";
      statusDiv.className = "status wet";
      play432().catch(()=>{});
      track.textContent = "432 Hz Calming Tone";
    }

    function setDry() {
      statusDiv.textContent = "Plant is Sad (Dry)";
      statusDiv.className = "status dry";
      playSad().catch(()=>{});
      track.textContent = "Sad Piano-Style Loop";
    }

    // ========= Web Serial =========
    document.getElementById("connect").addEventListener("click", async () => {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        serialPill.textContent = "Serial: connected";

        const decoder = new TextDecoderStream();
        const readableClosed = port.readable.pipeTo(decoder.writable);
        const reader = decoder.readable.getReader();

        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;
          buffer += value;
          let idx;
          while ((idx = buffer.indexOf("\n")) >= 0) {
            const line = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 1);
            if (!line) continue;
            if (line.includes("WET")) setWet();
            else if (line.includes("DRY")) setDry();
          }
        }
      } catch (e) {
        console.error(e);
        serialPill.textContent = "Serial: failed";
        alert("Serial connection failed. Make sure you're in a supported browser.");
      }
    });
  </script>
</body>
</html>
